const input = `O.........O.......O...OO.O...#.#.O.#O...O.#O..O.##.##.O...#..O..#..O..##O#.#........O#.O..#..#......
.OO..#OO.#.#.OO..#...O.OO.#......#.#OO..O##...##..#O#..#O##O.#....#O#O##.#.#O#.....O.#.O.#....O.....
..O.#.O.O#...#.#....#.#.....OO....#..O#....#.......O..OO..#..#.#O.O.OO...O.O...##...O.#...#.O.....O.
..O.O...#O....O#...O..#OO#....O.......O...#O##.O#....#O.#O.#.#.#...O#.O....O....##O#O#..O..#...#.O.O
##.O#.O..OOO..#....#.#..#..O.O.#.O.OO...##.O.O...#..##.O....O#..##.O.O....OO.....#OOO........O..#.OO
#..OO.#.....OO.........OOO.O..OOO.#O#..#.#O..O#..#OO.O...........O.O.O.......###.....#.#..O...#....#
#.O.O........#....O#..#OO...O..#.#.O..O.......#.O##.O.O........O..O.O.O.O#O.O#.....O.#.....#O.O.#O..
.O..O..O.O.O..#O.....O...O....#O...#...#O...OO..OO...#O..#.##.#O...O..##O...##...O#..#.....#.#...#..
OO..O#..#OOOO...##..#....O.#........#..O...#O......O..O..........#..O..##....OO....O.......#O...O.O.
.#..O.........#......OOO.O...#...O.O..#..OO.#..O..#....##....O.....O#.#O.O.OO...O..#...O....O.......
..#..O.#O.....#...OOO.#.........O.O.#.O...#OO.O...#O..#O..#..#O...#...O......O#......O..#O..O##.....
#.......#O...#O#O...O#O.O.O..............O.........O.O....#O##OO.O#..OO.....#.O..#.O.#.....OOO.#..#.
O..OOOO.......#O.O..O.#..#...O......#..#...#......OO....O..O.O.#....O.O...O..#...##.O.....#.OO..##..
.....#O.....O......#OO.#.O.#..#O.#..............#.O.....#.O.O..OO.#.#.#..O##.O.#O..O...O#...#.......
OOO.OOO#..##........#.#OO..OO#.#..O...O.#.O...##O#.OOO#OO.....#.O..#.O..O......##.#..#.#OO#...#..#..
......#O...O....O......O...#O..O.#...O....O.O...##.O.#....#O..O..............O#..............#.OO.O.
.#....##..O....O.O.#....O...O..O..O..#...#O.O..OOO.....O..#...#........O..#.OOO..O.#..#O.#.O........
O......O...#..O#.........#O..#..........O..#.O.O#.#.####.OO.#.O.....OO.#..#OO.O......##..##.....#.#.
#....##.O...#..##O...O......#OO.#OO.........OO#.O.O....O#....O#..O#...O...O#OO..O....O.#.O#.#..O.O..
......O.#...#O.......#..#...#.OOO..O.##..#.OO..OO...OO#O..O...OO.................#...O....#..OO...#O
..##....#O....O..#O..O..OO.O.O....O#.##..#O..O.O.O..#.OO#..O.....O.O...#OO.....#..#O.#...O#.........
..OO.O.OO.#.O..........#.O.O.#....#.......#.......OOO..#.....#..OO........#..O##O.....#...#O..O.....
.OO#.O#O...O#.O#..#OO.#......#.O.....O..#O...O......O.OO###....OO#.O.........##.#..O.....#..........
.O....O.O..O.....#.#...........#O.O.O#.............O....#....OO....#.....#OO..OO..OOO....O.O..#.OO.#
..O#.O....#..##...#...O....OO#O.#..O.O#..O..O..#..#....#....#..O..##..O.....#...O...#...#....#.OOO#O
.O..O..O...#....O.OO.##..OO#O.#.....#.O..O#O.OO...#.##O..OO.O......##..O.O..#..OO#O#.O#O....O#.....O
.OO...O##......O....##...O..##O##..O..OO##.#...O.##.OO.#.##....#.OO.....O..##.#.#..##O..O..O#..#O.O.
O.#.O...#....O.####OOOO.OO.O.O#..##......O#O....#OO.O.#.....O.....O.##....#....#...O#..O.OOO#O......
##..O.........O.....OO....O#O.O..#..#O..#..OO...OOOO..OO.O.....O##..##.#O............#O....O.O..O...
O.#..O.....#..#.#...O...O#.....O...#.OO...O.....O#.O.....O#O....##....#...O..#O...##..O...O...#..O..
.O##O.#.O..O..#..O...O#....O....O....#..O.....O##OOO.....O###O#.O.O.O.O.#.OO...O......##.#O.....#..O
.#OO.O#.#.#O...OO.OO....#OO.O#O..O..#..O..#.O.O.O..O#O...........O......OOO....#.O......#OO#..#OO#O.
...O#..#....#.O......#..O...OOO........O.#.#.....O.##......#....#...OO....O.O..O....O#.#.O#O.O....##
.....##..OO#..O#.O.#..O....OO.....##.OO..O...O#...###..O#O.O...O.#O#..O.O.....O..O......O......O#..#
O#..O#O...O.OO.OO....O###.#......#O....#O....O#...#O...O.....O#...........OO..O...O......#.#.#.O..#.
........#...#...O.O.#..OO..#O..O..O....OO...#....OO..###...#...#.#....O.OOO..#..O..###.O....O#OO..O.
.#O#O......O.....O#..O.O...O......O#..OO.#.#.O.O.O..O#.#........O.......#..#.O....#.....##........#.
O#O.O...#O.O#O.....#.....#####OOO..O#..#..#.#......O......#....#.....O.O..........#..##..O.........O
..#.O..OO......O.....O.OO..#.....O..##..#....O........#..O.#.......O...#OO#....##..O.#....O.O.#.O..O
.#...O..#OO.#.O...OO.O.##...OOOO....#..O..............O.###.#.O...#.##OOO#O..O....O...O#.###.....O.O
#O.#.O.#.O.....#...O#.O....##.........#..#.....O.....#...O..O.#O.O..O##..OOOO.......O.O#O.......O..O
.#.O.......OO....OO#.OO.#O.O....##.#...##OO....OO...O.###..O.##O..O#...#...#O#...#.#O#.O.#..OO.##..O
#.#.......O...O....#O#.#....#.O.#.....#......O...........#.O..#..O#.##...OO.#...O...#....O.......O..
....OO.O#O#..#O##O..#........#....O...OOO....##.#O..O...#..O.#O##..........O.#.O.....#O.OO.O#.....#.
..O.#O...##.....##..#.OO##.#...OOO.O.O......#.OO....O..#..#O...O.......O.....#O##..#....O#..O.##O.O.
O...O....O....#..O............#O.OO..#..OOO.........OO#.#.O.O..O.OO....O......#.O#.#....O..#O......O
#.......#...OOO.........#.#O.#O....O....O.O#...O#..O.O##O...O.#O..##O....OO........OO#.....#.#.O.#..
.#......O#.O.O..OOO.......O#...#...OO#O.......O.....#O#.#.O..O.OO...OO##.#..O....O.#..##...O.#..#.O#
.#..O......O.OO..#..#O.#..O#.O......#O..O.......##O.#...#....#..#.##O.#O...O....O.....O.#O...O#.O.#.
OOO.#O#..........O#..O.....#...O.O.O..O.O....O...O#....O.O..OO...##.#.O#OO......#...#.O.......O#.O..
....#.#.......O.....##O....O...O....O..O#.O.....O#OO..#OO....#....#...O.......##......O.OO.......OO#
.#........O.O..#.#...O..##.O.##..O.O.#....O..O#.#.#O.......O.......O.#.....O..#..#...#.O....OO.#.O..
.#.O.#.....#....#.#.O.#O..O.OO#..#...OO.......#O#..#O.#......O#.O..#......#.O#.OO...#..O.......O.O..
.#O##O#...O..........OO...OO..OO#...#OO..O....O..OOO...O.....##...O..#..###O.#O.###......O.OO#O#OO..
.##....#........#..O#......OO.....OOO.......O.OO...#O...#.O#..O...OO.OO#.......#.#.#.O#..#O.#.#..O..
#....#.##...O.OO..#.......O..O.O........O...O..OO.......#.O#O#.O.O.OO##.#.#...##.......#....O.O#....
...##....O#.#...O..#OO.O#.O...OO......O#.....#.##..O....#O.#....O..O.....OO#..#.O......#..#.##.#....
O#O......#.#O.........O...OO.#.OO...##.#...OO....O..##.......OOO.O..#...O.O...OO.....#.O..#..#O.....
.O.O#.........#.#...OOOOOO..#....#..O....OO...O..#....#..#.#O.#...O#..#.....O.##.O..#O#......O.O.O..
.#.O#......O##....##.#OO.OO..#...#...O..O....#O..O.#......#..#...#..O.....##...#...O.O.##OOO##......
...OO#O...O....O......O#.##...#.........OOO....O.#O#......OO.#......OOO.#..........O#O....OO.#.O.#.O
....O..O.O...#.......OOO.#...#O.#.....O.#..#.O.#..O.....O#.##..O..#..#...#O.....OO.#O......#....O..O
#....OO.O.O.OO#.O..#...#.#.##.O..OO...O#.OO..O#.#.O.#....O.O......O..##............O............O..O
#O#.O.O.....OO......#..OO...#....O..#.O...#O.#....O.....O.#.O.O.O..#...OO.O......O...#..#..O...#..OO
..#..#.OO#..O.....#....#O#...#......O....#OO.O....#O.....#..#.O....####..#.O..#...OO..#..OO..##..#..
..O...OO....#.#.#....#.O...#.....O.........OO..#.#O.O..O..#O..O.....OO..#.#.#...O....#....OOO.OOO.#O
.....##..O.O.O.O...#..OOO..........O.....##.#..O.#.....O......O.#....#...O....O..O.OOO.#O.....#..###
#...#....O#.O...O.......#.#......#..O.#.........O....OOO.O.O..O..O##..O#O..#..O.#.....###....#.....O
.#..O...#OO...O....O#O....#..###..#.O..##.O...O.....#O.OO......O#....#.....##.#..#......O.OO...##..O
.O....#O#.#...O..O....O#..OO.#O....O..O..#.O#O.O....O####...O..O...#.##...O...#....###OO#.O#..#O#OOO
O.......O#......O#OO...O..##.OO.O....O....#...O.#..OO#....OO..O##.O.OO..#.#O..#.O.#........#...O.#.#
O...O.###O.#..#.#O..O#.##O#.O.O.#..#.....O...#OO..#.#....#....O...#.OOOO.#...#...O.O..O..O....#..OO.
....###.....OO.O...#...O..........#O.##.O.O.OO..O...O#........O.#.#OO#O.........OOO..............#..
O.O.#.O##O..#OOOO.........O.O.O..#..O..O#.O....OO#...OO..#.O....OO.....OO..O..O.O#O#.O###OO..#OO.#.O
OOO..O#O#O#.#O.O#..OO..#......###O....#..O..O....OO....O.###.OOO....O.......O.OO.#...O#O..O#O..#....
..OO......O##..####...#O#O#.O.#..#.....#..OO....#O...........OO...#.O....#O...#....OO.O...#..OO.OO.O
#.....O..#.#..O..........#...#..O....O#........O#..O...O.##.#.O..O...O#O.O....#.....O..OO..#OO..#.#.
O.O...........#.O.O.O.....#.#O#...OO......O.#...........OO..O.#O..#....O.O...#..#OO.O.O#..#..O#OOO#O
.O#.#OO#..#..............OO.#.#........##..O...........O..#...##...OO..#O...#...OO.O.O.#..#..O...OO.
.O.#.........O..........#O.O.......O...##O...OO#O.#O#.#O#..#......O#O..#O.##.O#.#.#..#O.......#..#..
..OOO....O#O.......O....O#....#.....O#...#..O.#.O.O.O.#...#.O.....#.........#.O..#..#.....O..O.O..#.
...OO..O...#........#....O.O#.O#O..O.......#O.......O##...O#.O.#.#O#.....OOO.OOOO.##....O..O..O#.O..
..O...O...O....O..#..OO....OO...#.#...O...#O..O..#.#.....OO.....OOOO......O.##.#..OO#..O#.....O#O.#O
O.O.#O.#..##...O.OO...O.O...#.......#....O##..OO..#.O.O...O.O...##.......OO...#.O###.O...#.....O...O
..OO.....#O#OO##....O.###..##O.##.......O#O.#O..O.O#.O....O.#OO#...#..O.#.....#.O......O#O.O..O##O#.
..............O.O.#...OO.##.OO..OO....#...#..OOO.....#...#............O.O.......OO......OO.#O.#.....
........OO....O.##O.O#..##......O...OO..O#.O...O..........#.........#.....##...#.O#...O.O...........
..#.O...O.....O.OOO.O...##......#.##....#..#..#........#.O.O.O....O.#O.O#........#O..O.......O..O.#.
....OO#.....OO....#...O#..#.......#....O#...O..#..##.O..#..#.....#.#...OO..O..#...#..##.......O.O...
.......#....##O.....OOOO....#.O....OOOO.#.OO.##..O...O#..#.###..#....#......O.O...O.#O#.........O.##
...##O...OO#....#OO...O..#O........#....#...#O...#..#.O...#.........#..O....O..O..O.O..#O...O..#.O#.
...O.O.......OO.......#O.......O...O...OO.O#O.O...O..#..#O......#O.........O.O...O.O....O#O.O.OO..O#
#.#.#.#...#O.OO#..O..#O..#.....#...O.......O.#.O#.#....O.O...#OO.#......O.#..O...O.O...O..#.......#.
....#.#.....O........OO...#......#.O.O...##.OO..O#...#....O#........##...OO.#.....OO...#.#.O..#.#...
....OOO.#......##...O...O#.O..#.O.O...O..#.......OO.....O.#..OO..OOO#..O.#.#.O........OOO.#......#O#
.....#O.O...OO#OOOO#..#...##....O...#.O..O..#...#..OOO.O#O...#..O.#..OO#.#O...O.O.O.O.O.OOO.O..O..#.
...#....#.....O#O...OO.#.#.OOO.O..#...##OO.OO....O.O..O...O...OO.O..O....#O.#..........OO..#.OOO....
.#....#O#O..#O..O#.....#...#O#.....#O.O.#.##..#O.##.......O..#O.O..O........#.O#...#O##...##.......#
...#......O.O...OO#O..#....O....O...#..OOO.OO#..#...OOO.OO...O.#.#.#.O.O..O...#O....#.##....OO#.O..O
#...O.OO#O.O..O...#O.#..#.....O..OO...O..#...#.#.#..O......O..O.O.O.O...#..#O..#..#....#....#....O..`;

const tilt = (lines) => {
  for (let i = 0; i < lines.length; i++) {
    for (let j = 0; j < lines[i].length; j++) {
      if (lines[i][j] === "O") {
        let rI = i;
        while (lines[rI - 1] && lines[rI - 1][j] === ".") {
          rI -= 1;
        }
        lines[i][j] = ".";
        lines[rI][j] = "O";
      }
    }
  }
};

const rotate = (lines) =>
  lines.map((_, i) => lines.map((_, j) => lines[lines.length - 1 - j][i]));

const performCycle = (lines) => {
  for (let n = 0; n < 4; n++) {
    tilt(lines);
    lines = rotate(lines);
  }
  return lines;
};

const addWeights = (lines) => {
  const totalLines = lines.length;
  return lines.reduce(
    (acc, line, i) =>
      acc + line.filter((c) => c === "O").length * (totalLines - i),
    0,
  );
};

const solve1 = (input) => {
  const lines = input.split("\n").map((line) => line.split(""));
  tilt(lines);

  return addWeights(lines);
};

const solve2 = (input) => {
  const CYCLES = 1000000000;
  const hashes = new Map();
  let lines = input.split("\n").map((line) => line.split(""));
  for (let i = 0; i < CYCLES; i++) {
    const key = JSON.stringify(lines);

    lines = performCycle(lines);

    if (hashes.has(key)) {
      const cycleLength = i - hashes.get(key);
      const resultCacheI =
        hashes.size - cycleLength + ((CYCLES - hashes.size) % cycleLength);
      const resultLines = JSON.parse([...hashes.keys()][resultCacheI]);
      return addWeights(resultLines);
    }

    hashes.set(key, i);
  }
};

console.log(solve1(input));
console.log(solve2(input));
